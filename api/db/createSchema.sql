CREATE SCHEMA vulnerability;
GO
CREATE TABLE vulnerability.severity_type
(
    severity VARCHAR(256) NOT NULL PRIMARY KEY,
);
GO
CREATE TABLE vulnerability.runs
(
    id INT IDENTITY(1, 1) NOT NULL PRIMARY KEY,
    measured_time_utc DATETIME2,
);
GO
CREATE TABLE vulnerability.images
(
    id INT IDENTITY(1, 1) NOT NULL PRIMARY KEY,
    name VARCHAR(512),
    critical_severities INT,
    high_severities INT,
    medium_severities INT,
    low_severities INT,
    unknown_severities INT,
    run_id INT FOREIGN KEY REFERENCES vulnerability.runs(id),
)
CREATE TABLE vulnerability.pods
(
    id INT IDENTITY(1, 1) NOT NULL PRIMARY KEY,
    name VARCHAR(512),
    namespace VARCHAR(512),
    image_id INT FOREIGN KEY REFERENCES vulnerability.images(id),
)
CREATE TABLE vulnerability.vulnerabilties
(
    id INT IDENTITY(1, 1) NOT NULL PRIMARY KEY,
    target VARCHAR(256),
    cve_vulnerability_id VARCHAR(256),
    pkg_name VARCHAR(256),
    installed_version VARCHAR(256),
    layer_id VARCHAR(256),
    title VARCHAR(256),
    description VARCHAR(2048),
    severity VARCHAR(256) FOREIGN KEY REFERENCES vulnerability.severity_type(severity),
    image_id INT FOREIGN KEY REFERENCES vulnerability.images(id),
);
GO
CREATE TABLE vulnerability.vulnerability_references
(
    id INT IDENTITY(1, 1) NOT NULL PRIMARY KEY,
    vulnerability_id INT FOREIGN KEY REFERENCES vulnerability.vulnerabilties(id),
    uri VARCHAR(256),
);
GO
/* based on style guide: https://www.sqlstyle.guide/#do */

INSERT INTO vulnerability.severity_type (severity) VALUES ('CRITICAL')
INSERT INTO vulnerability.severity_type (severity) VALUES ('HIGH')
INSERT INTO vulnerability.severity_type (severity) VALUES ('MEDIUM')
INSERT INTO vulnerability.severity_type (severity) VALUES ('LOW')
INSERT INTO vulnerability.severity_type (severity) VALUES ('UNKNOWN')

DROP TABLE vulnerability.vulnerability_references;
DROP TABLE vulnerability.vulnerabilties;
DROP TABLE vulnerability.pods;
DROP TABLE vulnerability.images;
DROP TABLE vulnerability.runs;