const azure = require("azure-storage");

exports.vulnerabilities = () => {
  const tableName = "vulnerabilities";
  const imageTableName = "images";
  const imagePartitionKey = "reftable";

  const bootstrap = () => {
    const tableService = azure.createTableService();
    tableService.createTableIfNotExists(tableName, function (error) {
      if (error) {
        throw error;
      }
    });
    tableService.createTableIfNotExists(imageTableName, function (error) {
      if (error) {
        throw error;
      }
    });
  };

  const getImages = (callback) => {
    var tableService = azure.createTableService();
    var query = new azure.TableQuery().where(
      "PartitionKey eq ?",
      imagePartitionKey
    );

    tableService.queryEntities(imageTableName, query, null, function (
      error,
      result
    ) {
      if (!error) {
        const images = result.entries.map((entity) => entityToImage(entity));
        callback(images);
      } else {
        callback(null, error);
      }
    });
  };

  const getVulnerabilitiesByImage = (image, callback) => {
    var tableService = azure.createTableService();
    var query = new azure.TableQuery().where("PartitionKey eq ?", image);

    tableService.queryEntities(tableName, query, null, function (
      error,
      result
    ) {
      if (!error) {
        const vulnerabilities = result.entries.map((entity) =>
          entityToVul(entity)
        );
        callback(vulnerabilities);
      } else {
        callback(null, error);
      }
    });
  };

  const getVulnerabilityById = (image, id, callback) => {
    var tableService = azure.createTableService();
    tableService.retrieveEntity(tableName, image, id, function (error, result) {
      if (!error) {
        callback(entityToVul(result));
      } else {
        callback(null, error);
      }
    });
  };

  const saveVulnerability = (vul) => {
    const tableService = azure.createTableService();
    const entity = vulToEntity(vul);
    const imageEntity = imageToEntity(vul.Image);
    tableService.insertOrReplaceEntity(imageTableName, imageEntity, function (
      error
    ) {
      if (error) {
        console.log(error);
      }
    });
    tableService.insertOrReplaceEntity(tableName, entity, function (error) {
      if (error) {
        console.log(error);
      }
    });
  };

  const deleteVulnerabilityByImage = (image, callback) => {
    getVulnerabilitiesByImage(image, function (vulnerabilities) {
      const tableService = azure.createTableService();
      vulnerabilities.forEach((vul) => {
        const entity = vulToEntity(vul);
        tableService.deleteEntity(tableName, entity, function (error) {
          if (error) {
            console.log(error);
          }
        });
        callback();
      });
    });
  };

  const deleteVulnerabilityById = (image, id) => {
    getVulnerabilityById(image, id, function (vul) {
      const tableService = azure.createTableService();
      const entity = vulToEntity(vul);
      tableService.deleteEntity(tableName, entity, function (error) {
        if (error) {
          console.log(error);
        }
      });
    });
  };

  const imageToEntity = (image) => {
    const entGen = azure.TableUtilities.entityGenerator;
    return {
      PartitionKey: entGen.String(imagePartitionKey),
      RowKey: entGen.String(image),
    };
  };

  const entityToImage = (entity) => {
    return entity.RowKey ? entity.RowKey._ : "";
  };

  const vulToEntity = (vul) => {
    const entGen = azure.TableUtilities.entityGenerator;
    return {
      PartitionKey: entGen.String(vul.Image),
      RowKey: entGen.String(Buffer.from(vul.Target).toString("base64")),
      Target: entGen.String(vul.Target),
      Vulnerabilities: vul.Vulnerabilities
        ? JSON.stringify(vul.Vulnerabilities)
        : "",
    };
  };

  const entityToVul = (entity) => {
    return {
      Image: entity.PartitionKey ? entity.PartitionKey._ : "",
      Target: entity.Target ? entity.Target._ : "",
      Vulnerabilities:
        entity.Vulnerabilities && entity.Vulnerabilities._
          ? JSON.parse(entity.Vulnerabilities._)
          : [],
    };
  };

  return {
    bootstrap,
    getImages,
    getVulnerabilitiesByImage,
    getVulnerabilityById,
    saveVulnerability,
    deleteVulnerabilityById,
    deleteVulnerabilityByImage,
  };
};
